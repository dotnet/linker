# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# This pipeline will be extended to the OneESPT template
# If you are not using the E+D shared hosted pool with windows-2022, replace the pool section with your hosted pool, os, and image name. If you are using a Linux image, you must specify an additional windows image for SDL: https://eng.ms/docs/cloud-ai-platform/devdiv/one-engineering-system-1es/1es-docs/1es-pipeline-templates/features/sdlanalysis/overview#how-to-specify-a-windows-pool-for-the-sdl-source-analysis-stage
trigger:
  batch: true
  branches:
    include:
    - main
    - release/*
    - mono-*
pr:
  branches:
    include:
    - main
    - release/*
    - mono-*
    - feature/*
variables:
- name: _BuildConfig
  value: Release
- name: _BuildArgs
  value: ''
- name: _DotNetArtifactsCategory
  value: .NETCore
- name: _BuildArgs
  value: ${{ format('{0} /p:OfficialBuildId=$(Build.BuildNumber) /p:Test=false /p:IntegrationTest=false', variables['_BuildArgs']) }}
- group: DotNet-HelixApi-Access
- name: Codeql.Enabled
  value: True
- name: Codeql.TSAEnabled
  value: True
resources:
  repositories:
  - repository: 1ESPipelineTemplates
    type: git
    name: 1ESPipelineTemplates/1ESPipelineTemplates
    ref: refs/tags/release
extends:
  template: v1/1ES.Official.PipelineTemplate.yml@1ESPipelineTemplates
  parameters:
    pool:
      name: NetCore1ESPool-Svc-Internal
      image: 1es-windows-2022
      os: windows
    stages:
    - stage: build
      displayName: Build
      jobs:

      - job: SourceBuild_Managed
        displayName: Source-Build (Managed)
        pool:
          vmImage: ubuntu-latest
        container: 'mcr.microsoft.com/dotnet-buildtools/prereqs:centos-7-3e800f1-20190501005343'
        workspace:
          clean: all
        steps:
        - checkout: self
          submodules: true
        - template: /eng/common/templates/steps/source-build.yml
          parameters:
            enablePublishTestResults: true

      - template: /eng/common/templates-official/jobs/jobs.yml@self
        parameters:
          enableTelemetry: true
          helixRepo: dotnet/linker
          enablePublishUsingPipelines: true
          enablePublishBuildArtifacts: true
          enablePublishBuildAssets: true
          enableMicrobuild: true
          jobs:
          - job: Windows_NT
            variables:
            - _TeamName: .NET
            - _SignType: real
            - _PublishArgs: /p:DotNetArtifactsCategory=$(_DotNetArtifactsCategory) /p:DotNetPublishUsingPipelines=true
            - DotNetSignType: ${{ format('{0}', variables._SignType) }}
            steps:
            - checkout: self
              submodules: true
            - script: eng\common\cibuild.cmd -projects $(Build.SourcesDirectory)\illink.sln -configuration $(_BuildConfig) $(_BuildArgs) $(_PublishArgs) -integrationTest -nodeReuse "$false"
              env:
                MSBUILDENSURESTDOUTFORTASKPROCESSES: 1
                displayName: Build and publish illink.sln $(_BuildConfig)

    - template: /eng/common/templates-official/post-build/post-build.yml@self
      parameters:
        publishingInfraVersion: 3